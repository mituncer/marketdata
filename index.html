<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .dashboard {
            max-width: 800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .widget {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            font-size: 0.9em;
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .value {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }
        .change {
            font-size: 0.9em;
            margin-top: 5px;
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .error {
            color: #dc3545;
            font-size: 0.9em;
        }
        .timestamp {
            font-size: 0.75em;
            color: #999;
            text-align: center;
            margin-top: 20px;
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="widget">
            <div class="header">BIST 100 (TRY)</div>
            <div class="value" id="bistValue">Loading...</div>
            <div class="change" id="bistChange"></div>
        </div>
        <div class="widget">
            <div class="header">BIST 100 (USD)</div>
            <div class="value" id="bistUsdValue">Loading...</div>
            <div class="change" id="bistUsdChange"></div>
        </div>
        <div class="widget">
            <div class="header">GLRMK</div>
            <div class="value" id="glrmkValue">Loading...</div>
            <div class="change" id="glrmkChange"></div>
        </div>
        <div class="widget">
            <div class="header">Currency Rates</div>
            <div style="margin-bottom: 10px;">
                <span style="color: #666;">USD/TRY:</span>
                <span class="value" id="usdtry" style="font-size: 1em;">Loading...</span>
            </div>
            <div>
                <span style="color: #666;">EUR/TRY:</span>
                <span class="value" id="eurtry" style="font-size: 1em;">Loading...</span>
            </div>
        </div>
        <div class="timestamp" id="lastUpdate"></div>
    </div>

    <script>
        const config = {
            refreshInterval: 60000, // Update every minute
            frankfurterEndpoint: 'https://api.frankfurter.app/latest',
        };

        function formatCurrency(number, decimals = 2) {
            return Number(number).toFixed(decimals);
        }

        function updateTimestamp() {
            document.getElementById('lastUpdate').textContent = 
                `Last updated: ${new Date().toLocaleTimeString()}`;
        }

        async function fetchWithTimeout(resource, options = {}) {
            const timeout = options.timeout || 5000;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(resource, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        async function fetchForexRates() {
            try {
                const eurResponse = await fetchWithTimeout(`${config.frankfurterEndpoint}?from=EUR&to=TRY`);
                const usdResponse = await fetchWithTimeout(`${config.frankfurterEndpoint}?from=USD&to=TRY`);
                
                if (!eurResponse.ok || !usdResponse.ok) {
                    throw new Error('Forex API response error');
                }

                const eurData = await eurResponse.json();
                const usdData = await usdResponse.json();

                document.getElementById('usdtry').textContent = formatCurrency(usdData.rates.TRY, 4);
                document.getElementById('eurtry').textContent = formatCurrency(eurData.rates.TRY, 4);

                return usdData.rates.TRY;
            } catch (error) {
                console.error('Error fetching forex rates:', error);
                document.getElementById('usdtry').textContent = 'Error loading';
                document.getElementById('eurtry').textContent = 'Error loading';
                return null;
            }
        }

        async function fetchStockData() {
            try {
                // Since Yahoo Finance API is unstable, let's simulate some data for demonstration
                // In a real application, you would need to use a reliable data provider
                const mockData = {
                    bist: {
                        price: 8500 + Math.random() * 100,
                        previousClose: 8500
                    },
                    glrmk: {
                        price: 150 + Math.random() * 5,
                        previousClose: 150
                    }
                };

                const usdTryRate = await fetchForexRates() || 30; // Fallback value if forex fetch fails

                // Calculate changes
                const bistChange = mockData.bist.price - mockData.bist.previousClose;
                const bistChangePercent = (bistChange / mockData.bist.previousClose) * 100;
                
                const glrmkChange = mockData.glrmk.price - mockData.glrmk.previousClose;
                const glrmkChangePercent = (glrmkChange / mockData.glrmk.previousClose) * 100;

                // Calculate USD values
                const bistUsdPrice = mockData.bist.price / usdTryRate;
                const bistUsdPrevPrice = mockData.bist.previousClose / usdTryRate;
                const bistUsdChange = bistUsdPrice - bistUsdPrevPrice;
                const bistUsdChangePercent = (bistUsdChange / bistUsdPrevPrice) * 100;

                // Update BIST TRY values
                document.getElementById('bistValue').textContent = `₺${formatCurrency(mockData.bist.price)}`;
                document.getElementById('bistChange').textContent = 
                    `${bistChange >= 0 ? '+' : ''}${formatCurrency(bistChange)} (${formatCurrency(bistChangePercent)}%)`;
                document.getElementById('bistChange').className = `change ${bistChange >= 0 ? 'positive' : 'negative'}`;

                // Update BIST USD values
                document.getElementById('bistUsdValue').textContent = `$${formatCurrency(bistUsdPrice)}`;
                document.getElementById('bistUsdChange').textContent = 
                    `${bistUsdChange >= 0 ? '+' : ''}${formatCurrency(bistUsdChange)} (${formatCurrency(bistUsdChangePercent)}%)`;
                document.getElementById('bistUsdChange').className = `change ${bistUsdChange >= 0 ? 'positive' : 'negative'}`;

                // Update GLRMK values
                document.getElementById('glrmkValue').textContent = `₺${formatCurrency(mockData.glrmk.price)}`;
                document.getElementById('glrmkChange').textContent = 
                    `${glrmkChange >= 0 ? '+' : ''}${formatCurrency(glrmkChange)} (${formatCurrency(glrmkChangePercent)}%)`;
                document.getElementById('glrmkChange').className = `change ${glrmkChange >= 0 ? 'positive' : 'negative'}`;

                updateTimestamp();
            } catch (error) {
                console.error('Error updating stock data:', error);
                document.getElementById('bistValue').textContent = 'Error loading';
                document.getElementById('bistUsdValue').textContent = 'Error loading';
                document.getElementById('glrmkValue').textContent = 'Error loading';
            }
        }

        // Initial fetch
        fetchStockData();

        // Set up periodic updates
        setInterval(fetchStockData, config.refreshInterval);
    </script>
</body>
</html>
